name: Build and Deploy Frontend

on:
  push:
    branches: [ prod ]

jobs:
  build-and-deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install

    - name: Build project
      run: |
        npm run build
      env:
        CI: false

    - name: Verify build output
      run: |
        echo "Build contents:"
        ls -la dist/
        echo "Checking essential files:"
        [ -f dist/index.html ] && echo "✅ index.html exists" || echo "❌ index.html missing"
        [ -f dist/assets/index-*.js ] && echo "✅ JavaScript files exist" || ls -la dist/assets/ 2>/dev/null || echo "⚠️  Check asset structure"

    - name: Install sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass

    - name: Deploy to server
      run: |
        # Create deployment directory on server
        sshpass -p "${{ secrets.PASS }}" ssh -o StrictHostKeyChecking=no root@${{ secrets.HOST }} "mkdir -p /var/www/menu/client"
        
        # Copy dist folder to server
        echo "Copying dist folder to server..."
        sshpass -p "${{ secrets.PASS }}" scp -o StrictHostKeyChecking=no -r ./dist root@${{ secrets.HOST }}:/var/www/menu/client/
        
        # Fix permissions and verify
        sshpass -p "${{ secrets.PASS }}" ssh -o StrictHostKeyChecking=no root@${{ secrets.HOST }} "
          echo 'Fixing permissions...'
          chown -R www-data:www-data /var/www/menu/client/dist
          chmod -R 755 /var/www/menu/client/dist
          
          echo 'Verifying deployment:'
          ls -la /var/www/menu/client/dist/
          [ -f /var/www/menu/client/dist/index.html ] && echo '✅ Deployment successful' || echo '❌ Deployment failed'
          
          echo 'Reloading nginx...'
          sudo nginx -t && sudo systemctl reload nginx
          echo '✅ Nginx reloaded'
        "

    - name: Verify deployment
      run: |
        echo "Waiting for deployment to complete..."
        sleep 5
        echo "Testing deployed frontend:"
        curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" -k https://admin.stationonelounge.com

